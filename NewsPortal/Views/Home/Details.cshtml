@model NewsPortal.Models.Post
@{
    var user = ViewBag.User as NewsPortal.Models.User;
    var comments = ViewBag.Comments as List<NewsPortal.Models.Comment>;
    var feedback = ViewBag.Feedback as NewsPortal.Models.Feedback;
}

<h2>@Model.Title</h2>
<p>@Model.Body</p>

<div>
    <strong>Autor:</strong> @user?.Name
</div>

<div class="my-3">
    <strong>¿Te gustó esta noticia?</strong>
    <div id="feedback-section">
        @if (feedback != null)
        {
            <span class="badge bg-success" id="feedback-msg">
                @if (feedback.Sentimiento == "like")
                { <text>👍 ¡Gracias por tu feedback!</text> }
                else
                { <text>👎 ¡Gracias por tu feedback!</text> }
            </span>
        }
        else
        {
            <button class="btn btn-outline-success" onclick="sendFeedback('like')" id="btn-like">👍 Me gustó</button>
            <button class="btn btn-outline-danger" onclick="sendFeedback('dislike')" id="btn-dislike">👎 No me gustó</button>
        }
    </div>
</div>

<hr />
<h4>Comentarios</h4>
@if (comments?.Any() == true)
{
    <ul>
    @foreach (var c in comments)
    {
        <li>
            <strong>@c.Name</strong> (<i>@c.Email</i>)<br />
            @c.Body
        </li>
    }
    </ul>
}
else
{
    <p>No hay comentarios.</p>
}

@section Scripts {
<script>
    function sendFeedback(sentimiento) {
        var postData = {
            postId: @Model.Id,
            sentimiento: sentimiento
        };

        fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
        })
        .then(async response => {
            if (response.ok) {
                document.getElementById('feedback-section').innerHTML =
                    `<span class="badge bg-success" id="feedback-msg">` +
                    (sentimiento === 'like' ? '👍 ¡Gracias por tu feedback!' : '👎 ¡Gracias por tu feedback!') +
                    `</span>`;
            } else if (response.status === 409) {
                let msg = await response.text();
                document.getElementById('feedback-section').innerHTML =
                    `<span class="badge bg-warning">${msg}</span>`;
            } else {
                document.getElementById('feedback-section').innerHTML =
                    `<span class="badge bg-danger">Error al enviar feedback</span>`;
            }
        });
    }
</script>
}